# Malware Reverse Engineering Project
This is the C2 server made for a malware based on an previous analsys made for a graduate Reverse Engineering course that provided the artifact. 

## Table of contents
- [Description](#description)
- [Requirements](#requirements)
- [How to use](#how-to-use)
- [Packet Analysis](#packet-analysis)
- [References](#references)

## Description

This program is composed of a server running on port 1000. Once the malware connects to it, the server can establish a communication with it. As part of the communication, it can send commands and receive the malwares responses. These interactions with the malware are consistenly logged and kept in a file called server.log in the programs directory. The program also has a second server listening and receiving larger responses on port 1001. 


## Requirements

Dillinger uses a number of open source projects to work properly:

- [Python 3] 
    - pwntools
 - [Resource Hacker]
- [OllyDBG] 


## How to use

There's a couple of steps before we can properly run both the malware and server.

### Malware

Things to fix...

1.  Adding necessary resources
    - There's two DIALOG resources needed for the malware to actually be able to connect to our servers on port 1000 (main c2 server) and 1001 (dedicated large files receiver). However, using Resource Hacker we can easily add these missing resources and name them accordingly to 110 and 108, respectively.

![Resource Hacker](https://github.com/Deneb-Algedi/RE-PROJECT/blob/316f9e9bbb5dd9b91fbfc16fa0adfb35a3636bab/resource.png)

**Running the malware:**

For this, we could simply use OllyDbg. Opening the malware in OllyDbg and pressing start should load and run the malware running without any extra steps needed. 


### Server

Start the server:

```sh
python3 c2server.py
```

- **List of commands**

The following commands are included in the server:

![home-commands](https://github.com/MSE-QualityAssurance/project-phase-2-submission-Deneb-Algedi/blob/07f25e3e045699fea60e17de28aab5b34a8a03bf/home-commands.png)



- **Shortcommings**
    - When receiving pictures the image is visible but it's a bit corrupted, I'm guessing there could be more padding causing this and/or the jpg footer when writting the data to file. 
    - The screenshot command is not execute it, it raises an exception (I did not have time to investigate this). 
    - All the commands can be send, however, I did not finish reversing all of them. Hence, there are a few without names, arguments and description included in the server. 


- **Logging:**

A log file containing the ran commands and received responses from the malware of all sessions with the corresponding time and date will be stored in the same working direcotory as the server under a file called *server.log*. Below we can see what this file looks like and its contents:

![server Logs](https://github.com/Deneb-Algedi/RE-PROJECT/blob/3cdd07b1239bc635cd118c70d3008dd8156e19cd/serverlogs.png)

## Packet Analysis

- **Packet structure:**

The malware sends and receives packets with the same data structure. A data buffer which is padded with zeros after commands and arguments. Once the malware receives the data, it will first read the command in the first 4 bytes. After that, char arrays of size 712 and 100 will hold the arguments. To format my buffer accordingly, I placed the command in the beginning, immediately followed by the first argument padded with zeros until 712 bytes and lastly included the second argument. 

For example, consider the following commands: 

1. TITLE WINDOW, this command requires no arguments.

**Command structure:**
| command | 

![capture-titlewindow](https://github.com/Deneb-Algedi/RE-PROJECT/blob/7d319cf6bae3980ccd4e53ea9adcaeb2c769fc92/title-window.png)

As for the response, we can confirm that we receive a packet with the same structure as the one we sent from our server except its size.

**Response structure:**
| command | data | padding as needed

![capture-titlewindow](https://github.com/Deneb-Algedi/RE-PROJECT/blob/d10cae48f39deb3ebae497b646f1dd8e62c9f964/capture-titlewindow.png)


2. CLOSE PROCESS, this command requires one argument.

**Command structure:**
| command | argument1 |

![capture-closeprocess](https://github.com/Deneb-Algedi/RE-PROJECT/blob/ac753891e480d7a596cddec8a19003e5dc9e965e/capture-closeprocess.png)


3. COPY FILE, this command requires two arguments.   

**Command structure:**
| command | argument1 | padding as needed | argument2

![capture-copyfile](https://github.com/Deneb-Algedi/RE-PROJECT/blob/f6cb77fac5d4ee1e16b5c612ac65b6dec7e97023/capture-copyfile.png)


4. WEBCAM, this commands requires no arguments.

When sending bigger files, the malware relies on the server on port 1001. For this, it replies with data buffers of size 4116. The order and structure of the data contained in these packets it's the following:

**Command structure:**
| command | padding as needed

**Response structure:**

**First packet**
| \x03\x08 | Cam.jpg | padding

**Data packets**
| \x04\x08 | imgae data | padding as needed

**Last packet**
| \x05\x08 | Cam.jpg | padding
 

![capture-picture](https://github.com/Deneb-Algedi/RE-PROJECT/blob/e227a80ddfd2bde8b7ed142a2b578bcbdb9dbe7f/capture-picture.png)


## References

1. https://docs.python.org/3/howto/sockets.html
2. https://docs.python.org/3/howto/logging.html
3. https://realpython.com/intro-to-python-threading/

[Python 3]: <https://www.python.org/>
[Resource Hacker]: <http://www.angusj.com/resourcehacker/>
[OllyDBG]: <https://www.ollydbg.de/>

